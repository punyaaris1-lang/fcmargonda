<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FC MARGONDA - SYSTEM</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <link rel="apple-touch-icon" href="logo.png">
    
    <link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Teko:wght@300;400;500;600;700&family=Rajdhani:wght@500;600;700&family=Orbitron:wght@700;800;900&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --bg: #050505; 
            --primary: #0088FF; 
            --primary-dark: #004488; 
            --red: #FF003C; 
            --cyan: #00F0FF; 
            --green: #39FF14; 
            --neon-purple: #D000FF;
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; outline: none; }
        
        body { 
            font-family: 'Rajdhani', sans-serif; background: #000;
            background-image: linear-gradient(rgba(0, 136, 255, 0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(0, 136, 255, 0.03) 1px, transparent 1px);
            background-size: 20px 20px; 
            color: #ddd; margin: 0; padding: 15px 20px 120px 20px; 
            min-height: 100vh; display: flex; flex-direction: column; overflow-x: hidden;
        }

        /* --- UI COMPONENTS --- */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 20000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-box { width: 90%; max-width: 350px; background: #111; border: 1px solid var(--primary); padding: 25px; text-align: center; box-shadow: 0 0 20px rgba(0, 136, 255, 0.2); }
        .modal-title { font-family: 'Black Ops One'; color: var(--primary); font-size: 22px; margin-bottom: 10px; }
        .modal-msg { font-family: 'Rajdhani'; color: #fff; font-size: 16px; margin-bottom: 20px; }
        .modal-btns { display: flex; gap: 10px; justify-content: center; }
        .btn-modal { flex: 1; padding: 10px; font-family: 'Teko'; font-size: 18px; border: none; cursor: pointer; }
        .btn-yes { background: var(--primary); color: #fff; font-weight: bold; }
        .btn-no { background: #333; color: #fff; border: 1px solid #555; }

        .header { text-align: center; margin-bottom: 25px; margin-top: 10px; cursor: pointer; }
        .main-title { font-family: 'Black Ops One'; font-size: 32px; line-height: 1; color: #eee; text-shadow: 0 0 10px rgba(0,0,0,0.8); }
        .sub-title { font-size: 11px; color: var(--primary); letter-spacing: 3px; font-weight: 700; text-transform: uppercase; margin-top: 5px; }

        .queue-bar-wrapper { width: 100%; margin-bottom: 25px; cursor: pointer; }
        .queue-bar { background: #111; padding: 12px 20px; display: flex; align-items: center; justify-content: space-between; border-left: 2px solid var(--primary); border-radius: 0 10px 10px 0; }
        .qb-left { display: flex; flex-direction: column; }
        .qb-lbl { font-size: 9px; color: #666; letter-spacing: 2px; text-transform: uppercase; font-weight: 700; }
        .qb-val { font-family: 'Teko'; font-size: 28px; color: #fff; display: flex; align-items: center; gap: 10px; }
        .qb-tot { font-family: 'Black Ops One'; font-size: 36px; line-height: 0.8; color: #fff; }

        .slot-container { display: flex; flex-direction: column; gap: 12px; width: 100%; }

        .armor-card { width: 100%; min-height: 100px; position: relative; background: #080808; margin-bottom: 5px; border: 1px solid #222; display:flex; align-items: center; overflow: hidden; }
        .armor-card.active { border-color: #444; background: linear-gradient(90deg, #101010, #000); }
        .armor-card.active.can-kudeta { border-color: var(--red); box-shadow: 0 0 10px rgba(255,0,60,0.2); }
        
        .armor-num { width: 50px; height: 100px; display: flex; align-items: center; justify-content: center; font-family: 'Black Ops One'; font-size: 32px; color: #333; border-right: 1px solid #222; background: #050505; flex-shrink: 0; }
        .armor-card.active .armor-num { color: #fff; text-shadow: 0 0 5px rgba(255,255,255,0.3); }
        
        .armor-info { flex: 1; padding: 0 15px; display: flex; flex-direction: column; justify-content: center; overflow: hidden; }
        .info-name { font-family: 'Rajdhani'; font-weight: 700; font-size: 11px; color: #888; text-transform: uppercase; }
        .info-plat { font-family: 'Teko'; font-size: 40px; line-height: 0.9; color: #fff; letter-spacing: 0.5px; }
        
        .armor-timer { font-size: 10px; color: var(--primary); font-family: 'Orbitron'; margin-top: 2px; }
        
        .action-area { width: 100px; display: flex; flex-direction: column; justify-content: center; align-items: center; padding-right: 10px; gap: 5px; }
        
        /* TOMBOL-TOMBOL */
        .btn-pilih { background: var(--primary); color: #000; font-family: 'Rajdhani'; font-weight: bold; border: none; padding: 8px 15px; cursor: pointer; border-radius: 4px; animation: pulse 1.5s infinite; }
        .btn-kudeta { background: var(--red); color: #fff; font-family: 'Rajdhani'; font-weight: bold; border: none; padding: 5px 10px; cursor: pointer; border-radius: 4px; font-size: 10px; width: 100%; animation: flashRed 1s infinite; }
        .btn-stop { background: #333; color: #fff; border: 1px solid #555; padding: 5px 10px; font-size: 10px; cursor: pointer; border-radius: 4px; }

        @keyframes pulse { 0%{opacity:0.8;} 50%{opacity:1; box-shadow: 0 0 15px var(--primary);} 100%{opacity:0.8;} }
        @keyframes flashRed { 0%{opacity:1;} 50%{opacity:0.7; box-shadow: 0 0 10px var(--red);} 100%{opacity:1;} }

        /* RECOVERY & LOGIN */
        .bottom-links { margin-top: 30px; text-align: center; }
        .link-recover { color: #666; font-size: 11px; text-decoration: underline; cursor: pointer; }

        /* BADGE SIMPLE */
        .badge-role { font-size: 9px; padding: 2px 6px; background: #222; color: #aaa; border-radius: 2px; display: inline-block; margin-top: 2px; border: 1px solid #333; }
        
        .screen-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); backdrop-filter: blur(5px); z-index: 9999; display: none; flex-direction: column; justify-content: center; align-items: center; padding: 20px; }
        .login-card { width: 100%; max-width: 320px; background: #111; border: 1px solid #333; padding: 40px 20px; text-align: center; }
        .holo-input { background: transparent; border: none; border-bottom: 1px solid #555; width: 100%; color: #fff; font-family: 'Teko'; font-size: 32px; text-align: center; margin: 20px 0; text-transform: uppercase; }
        .btn-next { width: 100%; padding: 15px; background: var(--primary); color: #fff; font-family: 'Rajdhani'; font-weight: bold; font-size: 18px; border:none; border-radius: 50px; cursor: pointer; }
    </style>
</head>
<body>

    <div id="customModal" class="modal-overlay">
        <div class="modal-box">
            <div id="modalTitle" class="modal-title">TITLE</div>
            <div id="modalMsg" class="modal-msg">Message</div>
            <div id="modalBtns" class="modal-btns"></div>
        </div>
    </div>

    <div class="header" ondblclick="toggleAdmin()">
        <div class="main-title">FC MARGONDA</div>
        <div class="sub-title">SYSTEM MONITOR</div>
    </div>

    <div class="queue-bar-wrapper">
        <div class="queue-bar">
            <div class="qb-left">
                <span class="qb-lbl">ANTRIAN BERIKUTNYA</span>
                <div class="qb-val" id="nextQDisplay">--</div>
            </div>
            <div class="qb-right">
                <div class="qb-tot" id="totalQDisplay">0</div>
            </div>
        </div>
    </div>

    <div class="slot-container" id="slotsContainer"></div>

    <div class="bottom-links">
        <div class="link-recover" onclick="showRecoverModal()">LOGIN ULANG / PULIHKAN SESI</div>
        <div style="margin-top:10px; font-size:10px; color:#333;" onclick="resetApp()">[ RESET APP ]</div>
    </div>

    <div id="recoverModal" class="screen-overlay">
        <div class="login-card">
            <div style="font-size:12px; color:#666; margin-bottom:5px;">MASUKKAN PLAT NOMOR</div>
            <input type="text" id="recoverInput" class="holo-input" placeholder="B 1234 XYZ">
            <button class="btn-next" onclick="doRecovery()">CARI DATA SAYA</button>
            <button style="margin-top:20px; background:none; border:none; color:#666;" onclick="document.getElementById('recoverModal').style.display='none'">BATAL</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, runTransaction, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyAagBU9TGkVIHFk-eMFew4BK_ZG5UgQyYA",
          authDomain: "margonda-30359.firebaseapp.com",
          projectId: "margonda-30359",
          storageBucket: "margonda-30359.firebasestorage.app",
          messagingSenderId: "224624594572",
          appId: "1:224624594572:web:897879cc014d763bc1f5a9"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const mainRef = doc(db, "antrian", "utama");
        const historyRef = collection(db, "riwayatCharging");
        const logRef = collection(db, "activityLog");
        
        const $ = (id) => document.getElementById(id);
        let localSlots = [null, null, null];
        let localQueue = [];
        let myPlat = localStorage.getItem('myPlat'); 

        function cleanStr(s) { return s ? s.replace(/[^A-Z0-9]/gi, '').toUpperCase() : ''; }
        function addUserLog(action, details) { addDoc(logRef, { actor: myPlat || "GUEST", action: action, details: details, timestamp: new Date() }).catch(e=>{}); }

        // === MODALS ===
        window.showAlert = (msg, title="INFO") => {
            $('modalTitle').innerText = title; $('modalMsg').innerText = msg;
            $('modalBtns').innerHTML = `<button class="btn-modal btn-yes" onclick="closeCustomModal()">OK</button>`;
            $('customModal').style.display = 'flex';
        };
        window.showConfirm = (msg, callback) => {
            $('modalTitle').innerText = "KONFIRMASI"; $('modalMsg').innerText = msg;
            $('modalBtns').innerHTML = `<button class="btn-modal btn-no" onclick="closeCustomModal()">BATAL</button><button class="btn-modal btn-yes" id="btnYes">YA</button>`;
            $('btnYes').onclick = () => { closeCustomModal(); callback(); };
            $('customModal').style.display = 'flex';
        };
        window.closeCustomModal = () => { $('customModal').style.display = 'none'; };

        // === CORE LISTENER ===
        onSnapshot(mainRef, (snap) => {
            if (!snap.exists()) return;
            const d = snap.data();
            localSlots = d.chargingSlots || [null, null, null];
            localQueue = d.waitingQueue || [];
            updateUI();
        });

        // === UI RENDERER (DENGAN LOGIC KUDETA & PILIH SLOT) ===
        function updateUI() {
            const container = $('slotsContainer'); container.innerHTML = '';
            
            // Cek apakah saya urutan pertama di antrian
            let amIQueue1 = false;
            if(localQueue.length > 0 && myPlat) {
                if(cleanStr(localQueue[0].plat) === cleanStr(myPlat)) amIQueue1 = true;
            }

            localSlots.forEach((s, i) => {
                const isActive = s !== null;
                const div = document.createElement('div');
                
                // Hitung Durasi
                let durationMins = 0;
                let timerText = "";
                if (isActive) {
                    durationMins = Math.floor((Date.now() - s.startTime) / 60000);
                    timerText = `DURASI: ${durationMins} MENIT`;
                }

                // Logic Tampilan
                let actionHTML = "";
                const isMe = isActive && (cleanStr(s.plat) === cleanStr(myPlat));

                // 1. Slot Kosong & Saya Antrian #1 -> Tampilkan Tombol PILIH
                if (!isActive && amIQueue1) {
                    actionHTML = `<button class="btn-pilih" onclick="window.selectSlot(${i})">PILIH</button>`;
                }
                // 2. Slot Isi, Itu Saya -> Tombol Stop
                else if (isActive && isMe) {
                    actionHTML = `<button class="btn-stop" onclick="window.stopCharging(${i})">SELESAI</button>`;
                }
                // 3. Slot Isi, Bukan Saya, Saya Antrian #1, Durasi > 25 Menit -> Tombol KUDETA
                else if (isActive && !isMe && amIQueue1) {
                    if (durationMins >= 25) {
                        actionHTML = `<button class="btn-kudeta" onclick="window.attemptKudeta(${i}, '${s.plat}')">AMBIL ALIH</button>`;
                        div.classList.add('can-kudeta');
                    } else {
                        // Info kapan bisa kudeta
                        timerText += ` (KUDETA: ${25 - durationMins} mnt)`;
                    }
                }

                div.className = `armor-card ${isActive ? 'active' : ''}`;
                
                if (isActive) {
                    div.innerHTML = `
                        <div class="armor-num">${i+1}</div>
                        <div class="armor-info">
                            <div class="info-name">${s.userName} <span class="badge-role">${s.role || 'GUEST'}</span></div>
                            <div class="info-plat">${s.plat}</div>
                            <div class="armor-timer">${timerText}</div>
                        </div>
                        <div class="action-area">${actionHTML}</div>
                    `;
                } else {
                    div.innerHTML = `
                        <div class="armor-num" style="color:#222; background:#050505;">${i+1}</div>
                        <div class="armor-info" style="align-items:center;">
                            <div class="info-plat" style="color:#333; letter-spacing:5px;">KOSONG</div>
                        </div>
                        <div class="action-area">${actionHTML}</div>
                    `;
                }
                container.appendChild(div);
            });

            // Update Header Info
            $('totalQDisplay').innerText = localQueue.length;
            $('nextQDisplay').innerText = localQueue.length > 0 ? localQueue[0].plat : "--";
        }

        // === ACTIONS ===

        // 1. SELECT SLOT (Normal)
        window.selectSlot = async (i) => {
            showConfirm(`MASUK KE SLOT ${i+1}?`, () => {
                 runTransaction(db, async(t)=>{
                    const d = (await t.get(mainRef)).data(); 
                    if(d.chargingSlots[i]) throw "SLOT SUDAH DIAMBIL ORANG LAIN!";
                    
                    // Validasi Double Check
                    if(cleanStr(d.waitingQueue[0].plat) !== cleanStr(myPlat)) throw "ANDA BUKAN ANTRIAN PERTAMA!";
                    
                    let q = d.waitingQueue;
                    const me = q.shift(); // Ambil paling depan
                    me.startTime = Date.now(); 
                    d.chargingSlots[i] = me;
                    
                    t.update(mainRef, { chargingSlots: d.chargingSlots, waitingQueue: q });
                }).then(() => addUserLog("START", `Slot ${i+1}`)).catch(e => showAlert(e, "GAGAL"));
            });
        };

        // 2. STOP CHARGING
        window.stopCharging = (i) => {
             runTransaction(db, async(t)=>{ 
                 const d = (await t.get(mainRef)).data(); 
                 const u = d.chargingSlots[i];
                 if(u) addDoc(historyRef, {...u, finishTime: new Date(), action: "STOP"});
                 d.chargingSlots[i] = null; 
                 t.update(mainRef, {chargingSlots: d.chargingSlots}); 
             }).then(() => { localStorage.removeItem('myPlat'); myPlat=null; location.reload(); });
        };

        // 3. KUDETA (AMBIL ALIH)
        window.attemptKudeta = async (slotIdx, targetPlat) => {
            showConfirm(`AMBIL ALIH SLOT DARI ${targetPlat}?\nPastikan motor sudah selesai/kosong.`, () => {
                runTransaction(db, async(t) => {
                    const d = (await t.get(mainRef)).data();
                    const targetSlot = d.chargingSlots[slotIdx];
                    
                    // Validasi Slot
                    if(!targetSlot || cleanStr(targetSlot.plat) !== cleanStr(targetPlat)) throw "SLOT BERUBAH USER!";
                    
                    // Validasi Waktu (Server Side Check)
                    const duration = (Date.now() - targetSlot.startTime) / 60000;
                    if(duration < 25) throw "BELUM 25 MENIT!";

                    // Validasi Saya
                    if(cleanStr(d.waitingQueue[0].plat) !== cleanStr(myPlat)) throw "ANDA BUKAN ANTRIAN PERTAMA!";

                    // Proses:
                    // 1. Kick user lama ke history
                    const victim = targetSlot;
                    addDoc(historyRef, {...victim, finishTime: new Date(), action: "KICKED_BY_KUDETA", kicker: myPlat});
                    
                    // 2. Masukkan saya ke slot
                    let q = d.waitingQueue;
                    const me = q.shift();
                    me.startTime = Date.now();
                    d.chargingSlots[slotIdx] = me;

                    t.update(mainRef, { chargingSlots: d.chargingSlots, waitingQueue: q });
                }).then(() => {
                    addUserLog("KUDETA", `Success took over slot ${slotIdx+1} from ${targetPlat}`);
                    showAlert("BERHASIL AMBIL ALIH SLOT!", "KUDETA SUKSES");
                }).catch(e => showAlert(e, "GAGAL KUDETA"));
            });
        };

        // 4. RECOVERY / LOGIN ULANG
        window.showRecoverModal = () => { $('recoverModal').style.display = 'flex'; $('recoverInput').focus(); };
        
        window.doRecovery = () => {
            const inputVal = cleanStr($('recoverInput').value);
            if(!inputVal) return;

            // Cek di data lokal (snapshot terakhir)
            const inSlot = localSlots.some(s => s && cleanStr(s.plat) === inputVal);
            const inQueue = localQueue.some(q => cleanStr(q.plat) === inputVal);

            if(inSlot || inQueue) {
                localStorage.setItem('myPlat', $('recoverInput').value.toUpperCase());
                myPlat = $('recoverInput').value.toUpperCase();
                $('recoverModal').style.display = 'none';
                showAlert("SESI DIPULIHKAN! SILAHKAN LANJUTKAN.", "SUKSES");
                updateUI(); // Refresh tampilan agar tombol muncul
            } else {
                showAlert("DATA TIDAK DITEMUKAN DI ANTRIAN/SLOT AKTIF.", "GAGAL");
            }
        };

        // ADMIN SHORTCUT
        window.toggleAdmin = () => {
            let p = prompt("PASSWORD ADMIN:");
            if(p === "8899") window.location.href = "admin.html";
        };

        window.resetApp = () => showConfirm("RESET APLIKASI DI BROWSER INI?", () => { localStorage.clear(); location.reload(); });
        
        // Auto format input recovery
        $('recoverInput').addEventListener('input', function(e) {
            let v = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
            if (v.length > 0) {
                let match = v.match(/^([A-Z]{1,2})(\d{0,4})([A-Z]*)$/);
                if (match) v = match[1] + (match[2] ? " "+match[2] : "") + (match[3] ? " "+match[3] : "");
            }
            this.value = v;
        });

    </script>
</body>
</html>
