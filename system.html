<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, onSnapshot, runTransaction, collection, addDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // === CONFIG MARGONDA ===
    const firebaseConfig = {
      apiKey: "AIzaSyAagBU9TGkVIHFk-eMFew4BK_ZG5UgQyYA",
      authDomain: "margonda-30359.firebaseapp.com",
      projectId: "margonda-30359",
      storageBucket: "margonda-30359.firebasestorage.app",
      messagingSenderId: "224624594572",
      appId: "1:224624594572:web:897879cc014d763bc1f5a9"
    };

    const OFFICE_LOC = { lat: -6.396485, lng: 106.821571 };
    const MAX_KM = 0.2; // Radius lock 200m

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const mainRef = doc(db, "antrian", "utama");
    const historyRef = collection(db, "riwayatCharging");
    const logRef = collection(db, "activityLog");
    
    const $ = (id) => document.getElementById(id);
    let localSlots = [null, null, null];
    let localQueue = [];
    let myPlat = localStorage.getItem('myPlat'); 

    // === MODIFIED GPS LOCK (ADMIN BYPASS) ===
    window.checkLocation = () => {
        // 1. CEK APAKAH ADMIN? (Bypass GPS)
        // 'sa_sess' = Super Admin, 'adm_sess' = Admin Biasa
        if(localStorage.getItem('sa_sess') || localStorage.getItem('adm_sess')) {
            $('gpsBlocker').style.display = 'none'; // BUKA KUNCI LANGSUNG
            return;
        }

        // 2. JIKA BUKAN ADMIN, JALANKAN CEK GPS BIASA
        $('gpsMsg').innerText = "";
        if(!navigator.geolocation) {
            $('gpsMsg').innerText = "GPS TIDAK DIDUKUNG BROWSER"; return;
        }
        navigator.geolocation.getCurrentPosition((pos) => {
            const dist = getDist(pos.coords.latitude, pos.coords.longitude, OFFICE_LOC.lat, OFFICE_LOC.lng);
            if (dist <= MAX_KM) {
                $('gpsBlocker').style.display = 'none'; // LOKASI AMAN
            } else {
                $('gpsMsg').innerText = `LOKASI: ${dist.toFixed(2)} KM DARI SHOWROOM. HARAP MENDEKAT.`;
            }
        }, (err) => {
            $('gpsMsg').innerText = "AKSES LOKASI DITOLAK/ERROR. WAJIB AKTIFKAN GPS.";
        }, { enableHighAccuracy: true });
    };
    
    function getDist(lat1, lon1, lat2, lon2) {
        const R = 6371; const dLat = (lat2 - lat1) * Math.PI / 180; const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
        return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)));
    }

    // Jalankan cek lokasi saat start
    window.onload = checkLocation;

    // === (SISA SCRIPT BAWAAN SYSTEM.HTML TETAP SAMA SEPERTI SEBELUMNYA) ===
    function cleanStr(s) { return s ? s.replace(/[^A-Z0-9]/gi, '').toUpperCase() : ''; }
    function addUserLog(action, details) { addDoc(logRef, { actor: myPlat || "GUEST", action: action, details: details, timestamp: new Date() }).catch(e=>{}); }

    window.showAlert = (msg, title="INFO") => { $('modalTitle').innerText = title; $('modalMsg').innerText = msg; $('modalBtns').innerHTML = `<button class="btn-modal btn-yes" onclick="closeCustomModal()">OK</button>`; $('customModal').style.display = 'flex'; };
    window.showConfirm = (msg, callback) => { $('modalTitle').innerText = "KONFIRMASI"; $('modalMsg').innerText = msg; $('modalBtns').innerHTML = `<button class="btn-modal btn-no" onclick="closeCustomModal()">BATAL</button><button class="btn-modal btn-yes" id="btnYes">YA</button>`; $('btnYes').onclick = () => { closeCustomModal(); callback(); }; $('customModal').style.display = 'flex'; };
    window.closeCustomModal = () => { $('customModal').style.display = 'none'; };

    onSnapshot(mainRef, (snap) => {
        if (!snap.exists()) return;
        const d = snap.data();
        localSlots = d.chargingSlots || [null, null, null];
        localQueue = d.waitingQueue || [];
        updateUI();
    });

    function updateUI() {
        const container = $('slotsContainer'); container.innerHTML = '';
        let amIQueue1 = false;
        if(localQueue.length > 0 && myPlat) { if(cleanStr(localQueue[0].plat) === cleanStr(myPlat)) amIQueue1 = true; }

        localSlots.forEach((s, i) => {
            const isActive = s !== null;
            const div = document.createElement('div');
            let durationMins = 0; let timerText = ""; let actionHTML = "";
            const isMe = isActive && (cleanStr(s.plat) === cleanStr(myPlat));

            if (isActive) {
                durationMins = Math.floor((Date.now() - s.startTime) / 60000);
                timerText = `DURASI: ${durationMins} MENIT`;
            }

            if (!isActive && amIQueue1) { actionHTML = `<button class="btn-pilih" onclick="window.selectSlot(${i})">PILIH</button>`; }
            else if (isActive && isMe) { actionHTML = `<button class="btn-stop" onclick="window.stopCharging(${i})">SELESAI</button>`; }
            else if (isActive && !isMe && amIQueue1) {
                if (durationMins >= 25) { actionHTML = `<button class="btn-kudeta" onclick="window.attemptKudeta(${i}, '${s.plat}')">AMBIL ALIH</button>`; div.classList.add('can-kudeta'); } 
                else { timerText += ` (KUDETA: ${25 - durationMins} mnt)`; }
            }

            div.className = `armor-card ${isActive ? 'active' : ''}`;
            if (isActive) {
                div.innerHTML = `<div class="armor-num">${i+1}</div><div class="armor-info"><div class="info-name">${s.userName} <span class="badge-role">${s.role || 'GUEST'}</span></div><div class="info-plat">${s.plat}</div><div class="armor-timer">${timerText}</div></div><div class="action-area">${actionHTML}</div>`;
            } else {
                div.innerHTML = `<div class="armor-num" style="color:#222; background:#050505;">${i+1}</div><div class="armor-info" style="align-items:center;"><div class="info-plat" style="color:#333; letter-spacing:5px;">KOSONG</div></div><div class="action-area">${actionHTML}</div>`;
            }
            container.appendChild(div);
        });
        $('totalQDisplay').innerText = localQueue.length;
        $('nextQDisplay').innerText = localQueue.length > 0 ? localQueue[0].plat : "--";
    }

    window.selectSlot = async (i) => {
        showConfirm(`MASUK KE SLOT ${i+1}?`, () => {
             runTransaction(db, async(t)=>{
                const d = (await t.get(mainRef)).data(); 
                if(d.chargingSlots[i]) throw "SLOT SUDAH DIAMBIL ORANG LAIN!";
                if(cleanStr(d.waitingQueue[0].plat) !== cleanStr(myPlat)) throw "ANDA BUKAN ANTRIAN PERTAMA!";
                let q = d.waitingQueue; const me = q.shift(); me.startTime = Date.now(); d.chargingSlots[i] = me;
                t.update(mainRef, { chargingSlots: d.chargingSlots, waitingQueue: q });
            }).then(() => addUserLog("START", `Slot ${i+1}`)).catch(e => showAlert(e, "GAGAL"));
        });
    };

    window.stopCharging = (i) => {
         showConfirm("SELESAI CHARGING? SESI AKAN DIHAPUS.", () => {
             runTransaction(db, async(t)=>{ 
                 const d = (await t.get(mainRef)).data(); const u = d.chargingSlots[i];
                 if(u) addDoc(historyRef, {...u, finishTime: new Date(), action: "STOP"});
                 d.chargingSlots[i] = null; t.update(mainRef, {chargingSlots: d.chargingSlots}); 
             }).then(() => { localStorage.clear(); myPlat=null; location.reload(); });
         });
    };

    window.attemptKudeta = async (slotIdx, targetPlat) => {
        showConfirm(`AMBIL ALIH SLOT DARI ${targetPlat}?`, () => {
            runTransaction(db, async(t) => {
                const d = (await t.get(mainRef)).data();
                const targetSlot = d.chargingSlots[slotIdx];
                if(!targetSlot || cleanStr(targetSlot.plat) !== cleanStr(targetPlat)) throw "SLOT BERUBAH USER!";
                const duration = (Date.now() - targetSlot.startTime) / 60000;
                if(duration < 25) throw "BELUM 25 MENIT!";
                if(cleanStr(d.waitingQueue[0].plat) !== cleanStr(myPlat)) throw "ANDA BUKAN ANTRIAN PERTAMA!";
                const victim = targetSlot;
                addDoc(historyRef, {...victim, finishTime: new Date(), action: "KICKED_BY_KUDETA", kicker: myPlat});
                let q = d.waitingQueue; const me = q.shift(); me.startTime = Date.now(); d.chargingSlots[slotIdx] = me;
                t.update(mainRef, { chargingSlots: d.chargingSlots, waitingQueue: d.waitingQueue });
            }).then(() => { addUserLog("KUDETA", `Success took over slot ${slotIdx+1}`); showAlert("BERHASIL AMBIL ALIH SLOT!", "KUDETA SUKSES"); }).catch(e => showAlert(e, "GAGAL KUDETA"));
        });
    };

    window.showRecoverModal = () => { $('recoverModal').style.display = 'flex'; $('recoverInput').focus(); };
    window.doRecovery = () => {
        const inputVal = cleanStr($('recoverInput').value); if(!inputVal) return;
        const inSlot = localSlots.some(s => s && cleanStr(s.plat) === inputVal);
        const inQueue = localQueue.some(q => cleanStr(q.plat) === inputVal);
        if(inSlot || inQueue) { localStorage.setItem('myPlat', $('recoverInput').value.toUpperCase()); myPlat = $('recoverInput').value.toUpperCase(); $('recoverModal').style.display = 'none'; showAlert("SESI DIPULIHKAN!", "SUKSES"); updateUI(); } 
        else { showAlert("DATA TIDAK DITEMUKAN.", "GAGAL"); }
    };

    window.showQueueList = () => {
        const listDiv = $('fullQueueList'); listDiv.innerHTML = '';
        if(localQueue.length === 0) { listDiv.innerHTML = '<div style="padding:10px; color:#666; text-align:center;">ANTRIAN KOSONG</div>'; } 
        else {
            localQueue.forEach((q, idx) => {
                const row = document.createElement('div'); row.className = 'q-item';
                row.innerHTML = `<div><span style="color:var(--primary); font-family:'Teko'; font-size:20px;">#${q.qNo}</span><span style="color:#fff; font-weight:bold; margin-left:10px;">${q.plat}</span><div style="font-size:10px; color:#888;">${q.userName}</div></div><span class="badge-role">${q.role || 'GUEST'}</span>`;
                listDiv.appendChild(row);
            });
        }
        $('queueListModal').style.display = 'flex';
    };

    window.toggleAdmin = () => { let p = prompt("PASSWORD ADMIN:"); if(p === "8899") window.location.href = "admin.html"; };
    window.resetApp = () => showConfirm("RESET APLIKASI DI BROWSER INI?", () => { localStorage.clear(); location.reload(); });
    $('recoverInput').addEventListener('input', function(e) { let v = this.value.toUpperCase().replace(/[^A-Z0-9]/g, ''); if (v.length > 0) { let match = v.match(/^([A-Z]{1,2})(\d{0,4})([A-Z]*)$/); if (match) v = match[1] + (match[2] ? " "+match[2] : "") + (match[3] ? " "+match[3] : ""); } this.value = v; });
    
    // REGISTER SW
    if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js'); }); }
</script>
